{% extends "base.html" %}
{% load static %}

{% block title %}PromptBase - Discover AI Prompts{% endblock %}

{% block content %}
<div class="container-fluid px-4 py-4">
  
  {% if not user.is_authenticated %}
  <div class="alert alert-info alert-dismissible fade show mb-4" role="alert">
    <i class="bi bi-info-circle me-2"></i>
    <strong>Welcome!</strong> You can browse prompts freely. 
    <a href="{% url 'signup' %}" class="alert-link">Sign up</a> to add your own.
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  </div>
  {% endif %}

  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="mb-0 text-white">Latest Prompts</h2>
    <span class="small">{{ paginator.count }} prompts</span>
  </div>

  {% if prompts %}
  <div class="prompt-grid">
    {% for prompt in prompts %}
    <div class="prompt-card" onclick="showPromptModal({{ prompt.id }})">
      <div class="prompt-header">
        <h6 class="prompt-title">{{ prompt.title }}</h6>
        <span class="prompt-type">{{ prompt.get_type_display }}</span>
      </div>
      
      <p class="prompt-preview">{{ prompt.content|truncatewords:12 }}</p>
      
      <div class="prompt-footer">
        <div class="prompt-tags">
          {% for tag in prompt.tags.all|slice:":3" %}
          <span class="tag">#{{ tag.name }}</span>
          {% endfor %}
        </div>
        <div class="prompt-meta">
          <span class="creator">{{ prompt.creator.username }}</span>
          <span class="separator">·</span>
          <span class="time">{{ prompt.created_at|timesince }}</span>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>

  {% if is_paginated %}
  <nav aria-label="Prompt pagination" class="mt-4">
    <ul class="pagination justify-content-center">
      {% if page_obj.has_previous %}
      <li class="page-item">
        <a class="page-link bg-dark text-white border-secondary" href="?page=1">First</a>
      </li>
      <li class="page-item">
        <a class="page-link bg-dark text-white border-secondary" href="?page={{ page_obj.previous_page_number }}">Previous</a>
      </li>
      {% endif %}

      <li class="page-item active">
        <span class="page-link bg-primary border-primary">
          Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
        </span>
      </li>

      {% if page_obj.has_next %}
      <li class="page-item">
        <a class="page-link bg-dark text-white border-secondary" href="?page={{ page_obj.next_page_number }}">Next</a>
      </li>
      <li class="page-item">
        <a class="page-link bg-dark text-white border-secondary" href="?page={{ page_obj.paginator.num_pages }}">Last</a>
      </li>
      {% endif %}
    </ul>
  </nav>
  {% endif %}

  {% else %}
  <div class="text-center py-5">
    <i class="bi bi-inbox display-1 text-muted"></i>
    <h3 class="mt-3 text-white">No prompts yet</h3>
    <p class="text-muted">Be the first to add a prompt!</p>
    {% if user.is_authenticated %}
    <a href="{% url 'prompt_add' %}" class="btn btn-primary mt-2">
      <i class="bi bi-plus-lg me-1"></i>Add Prompt
    </a>
    {% endif %}
  </div>
  {% endif %}

</div>

<div class="modal fade" id="promptModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content bg-dark text-white border-secondary">
      <div class="modal-header border-secondary">
        <h5 class="modal-title text-white" id="modalTitle"></h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <span class="badge bg-secondary me-2" id="modalType"></span>
          <small class="text-muted" id="modalMeta"></small>
        </div>
        <div class="mb-3" id="modalTags"></div>
        <div class="bg-black p-3 rounded">
          <pre class="mb-0 text-white font-monospace" id="modalContent" style="white-space: pre-wrap; word-wrap: break-word;"></pre>
        </div>
      </div>
      <div class="modal-footer border-secondary">
        <button type="button" class="btn btn-secondary" onclick="copyPrompt(event)">
          <i class="bi bi-clipboard me-1"></i>Copy
        </button>
        <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<style>
.prompt-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
  gap: 16px;
}

.prompt-card {
  background-color: #1a1a1a;
  border: 1px solid #2a2a2a;
  border-left: 3px solid transparent;
  border-radius: 8px;
  padding: 16px;
  cursor: pointer;
  transition: all 0.2s ease;
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.prompt-card:hover {
  border-left-color: #0d6efd;
  transform: translateY(-2px);
  background-color: #1e1e1e;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
}

.prompt-header {
  display: flex;
  justify-content: space-between;
  align-items: start;
  gap: 12px;
}

.prompt-title {
  color: #fff;
  font-size: 0.95rem;
  font-weight: 600;
  margin: 0;
  line-height: 1.3;
  flex: 1;
}

.prompt-type {
  background-color: #2a2a2a;
  color: #aaa;
  padding: 3px 8px;
  border-radius: 4px;
  font-size: 0.7rem;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  white-space: nowrap;
  flex-shrink: 0;
}

.prompt-preview {
  color: #888;
  font-size: 0.85rem;
  line-height: 1.4;
  margin: 0;
  overflow: hidden;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
}

.prompt-footer {
  display: flex;
  flex-direction: column;
  gap: 8px;
  margin-top: auto;
}

.prompt-tags {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
}

.tag {
  background-color: #0d6efd15;
  color: #6ea8fe;
  padding: 2px 8px;
  border-radius: 4px;
  font-size: 0.75rem;
  border: 1px solid #0d6efd30;
}

.prompt-meta {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 0.75rem;
  color: #666;
}

.creator {
  color: #aaa;
  font-weight: 500;
}

.separator {
  color: #444;
}

.time {
  color: #666;
}
</style>

<script>
let currentPromptContent = '';

async function showPromptModal(promptId) {
  try {
    const response = await fetch(`/prompt/${promptId}/detail/`);
    const data = await response.json();
    
    document.getElementById('modalTitle').textContent = data.title;
    document.getElementById('modalType').textContent = data.type.toUpperCase();
    document.getElementById('modalMeta').textContent = `by ${data.creator} · ${data.created_at}`;
    document.getElementById('modalContent').textContent = data.content;
    
    const tagsHtml = data.tags.map(tag => 
      `<span class="badge bg-dark border border-secondary text-white me-1">#${tag}</span>`
    ).join('');
    document.getElementById('modalTags').innerHTML = tagsHtml;
    
    currentPromptContent = data.content;
    
    const modal = new bootstrap.Modal(document.getElementById('promptModal'));
    modal.show();
  } catch (error) {
    console.error('Error loading prompt:', error);
  }
}

function copyPrompt(event) {
  navigator.clipboard.writeText(currentPromptContent).then(() => {
    const btn = event.target.closest('button');
    const originalHtml = btn.innerHTML;
    btn.innerHTML = '<i class="bi bi-check-lg me-1"></i>Copied!';
    btn.classList.add('btn-success');
    btn.classList.remove('btn-secondary');
    setTimeout(() => {
      btn.innerHTML = originalHtml;
      btn.classList.remove('btn-success');
      btn.classList.add('btn-secondary');
    }, 2000);
  }).catch(err => {
    console.error('Failed to copy:', err);
    alert('Failed to copy prompt');
  });
}
</script>
{% endblock %}
