{% extends "base.html" %}
{% load static %}

{% block title %}PromptBase - Discover AI Prompts{% endblock %}

{% block content %}
<div class="container-fluid px-4 py-4">
  
  {% if not user.is_authenticated %}
  <div class="alert alert-info alert-dismissible fade show mb-4" role="alert">
    <i class="bi bi-info-circle me-2"></i>
    <strong>Welcome!</strong> You can browse prompts freely. 
    <a href="{% url 'signup' %}" class="alert-link">Sign up</a> to add your own.
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  </div>
  {% endif %}

  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="mb-0 text-white">Latest Prompts</h2>
    <div class="">{{ paginator.count }} prompts</div>
  </div>

  {% if prompts %}
  <div class="prompt-list">
    {% for prompt in prompts %}
    <div class="prompt-item card bg-dark border-secondary mb-3 cursor-pointer" 
         data-prompt-id="{{ prompt.id }}" onclick="showPromptModal({{ prompt.id }})">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-start mb-2">
          <h5 class="card-title text-white mb-0">{{ prompt.title }}</h5>
          <span class="badge bg-secondary">{{ prompt.get_type_display }}</span>
        </div>
        
        <p class="card-text text-muted small mb-2">
          {{ prompt.content|truncatewords:15 }}
        </p>
        
        <div class="d-flex justify-content-between align-items-center">
          <div class="tags">
            {% for tag in prompt.tags.all %}
            <span class="badge bg-dark border border-secondary text-white me-1">#{{ tag.name }}</span>
            {% endfor %}
          </div>
          <small class="text-white">
            by <strong class="text-white">{{ prompt.creator.username }}</strong> · 
            {{ prompt.created_at|timesince }} ago
          </small>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>

  {% if is_paginated %}
  <nav aria-label="Prompt pagination" class="mt-4">
    <ul class="pagination justify-content-center">
      {% if page_obj.has_previous %}
      <li class="page-item">
        <a class="page-link bg-dark text-white border-secondary" href="?page=1">First</a>
      </li>
      <li class="page-item">
        <a class="page-link bg-dark text-white border-secondary" href="?page={{ page_obj.previous_page_number }}">Previous</a>
      </li>
      {% endif %}

      <li class="page-item active">
        <span class="page-link bg-primary border-primary">
          Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
        </span>
      </li>

      {% if page_obj.has_next %}
      <li class="page-item">
        <a class="page-link bg-dark text-white border-secondary" href="?page={{ page_obj.next_page_number }}">Next</a>
      </li>
      <li class="page-item">
        <a class="page-link bg-dark text-white border-secondary" href="?page={{ page_obj.paginator.num_pages }}">Last</a>
      </li>
      {% endif %}
    </ul>
  </nav>
  {% endif %}

  {% else %}
  <div class="text-center py-5">
    <i class="bi bi-inbox display-1 text-muted"></i>
    <h3 class="mt-3 text-white">No prompts yet</h3>
    <p class="text-muted">Be the first to add a prompt!</p>
    {% if user.is_authenticated %}
    <a href="{% url 'prompt_add' %}" class="btn btn-primary mt-2">
      <i class="bi bi-plus-lg me-1"></i>Add Prompt
    </a>
    {% endif %}
  </div>
  {% endif %}

</div>

<div class="modal fade" id="promptModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content bg-dark text-white border-secondary">
      <div class="modal-header border-secondary">
        <h5 class="modal-title text-white" id="modalTitle"></h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <span class="badge bg-secondary me-2" id="modalType"></span>
          <small class="text-muted" id="modalMeta"></small>
        </div>
        <div class="mb-3" id="modalTags"></div>
        <div class="bg-black p-3 rounded">
          <pre class="mb-0 text-white font-monospace" id="modalContent" style="white-space: pre-wrap; word-wrap: break-word;"></pre>
        </div>
      </div>
      <div class="modal-footer border-secondary">
        <button type="button" class="btn btn-secondary" onclick="copyPrompt(event)">
          <i class="bi bi-clipboard me-1"></i>Copy
        </button>
        <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<style>
.cursor-pointer {
  cursor: pointer;
  transition: transform 0.2s, box-shadow 0.2s;
}
.cursor-pointer:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
}
.prompt-item {
  border-left: 3px solid transparent;
}
.prompt-item:hover {
  border-left-color: #0d6efd;
}
</style>

<script>
let currentPromptContent = '';



async function showPromptModal(promptId) {
  try {
    const response = await fetch(`/prompt/${promptId}/detail/`);
    const data = await response.json();
    
    document.getElementById('modalTitle').textContent = data.title;
    document.getElementById('modalType').textContent = data.type.toUpperCase();
    document.getElementById('modalMeta').textContent = `by ${data.creator} · ${data.created_at}`;
    document.getElementById('modalContent').textContent = data.content;
    
    const tagsHtml = data.tags.map(tag => 
      `<span class="badge bg-dark border border-secondary text-white me-1">#${tag}</span>`
    ).join('');
    document.getElementById('modalTags').innerHTML = tagsHtml;
    
    currentPromptContent = data.content;
    
    const modal = new bootstrap.Modal(document.getElementById('promptModal'));
    modal.show();
  } catch (error) {
    console.error('Error loading prompt:', error);
  }
}

function copyPrompt(event) {
  navigator.clipboard.writeText(currentPromptContent).then(() => {
    const btn = event.target.closest('button');
    const originalHtml = btn.innerHTML;
    btn.innerHTML = '<i class="bi bi-check-lg me-1"></i>Copied!';
    btn.classList.add('btn-success');
    btn.classList.remove('btn-secondary');
    setTimeout(() => {
      btn.innerHTML = originalHtml;
      btn.classList.remove('btn-success');
      btn.classList.add('btn-secondary');
    }, 2000);
  }).catch(err => {
    console.error('Failed to copy:', err);
    alert('Failed to copy prompt');
  });
}

</script>
{% endblock %}
